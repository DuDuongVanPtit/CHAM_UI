<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHAM TOEIC - Bài kiểm tra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cham-blue': '#1E40AF',
                        'cham-light-blue': '#3B82F6',
                        'cham-orange': '#F97316',
                        'cham-green': '#10B981',
                        'cham-red': '#EF4444',
                        'cham-yellow': '#F59E0B',
                        'cham-purple': '#8B5CF6',
                        'cham-gray': '#6B7280'
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Prevent text selection and right-click */
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* High contrast mode */
        .high-contrast {
            filter: contrast(150%) brightness(120%);
        }
        
        /* Smooth transitions */
        .smooth-transition {
            transition: all 0.3s ease;
        }
        
        /* Question palette */
        .question-palette {
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* Audio controls */
        .audio-controls {
            background: linear-gradient(135deg, #1E40AF 0%, #3B82F6 100%);
        }
        
        /* Timer warning animations */
        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .timer-warning {
            animation: pulse-warning 1s infinite;
        }
        
        /* Loading spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        
        /* Zoom functionality */
        .zoomable {
            cursor: zoom-in;
            transition: transform 0.3s ease;
        }
        
        .zoomable.zoomed {
            transform: scale(1.5);
            cursor: zoom-out;
            z-index: 50;
            position: relative;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans overflow-hidden" oncontextmenu="return false">
    <!-- Fixed Header Bar -->
    <header class="bg-white shadow-sm border-b border-gray-200 fixed top-0 left-0 right-0 z-40">
        <div class="px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <!-- Test Info -->
                <div class="flex items-center space-x-4">
                    <div class="flex-shrink-0">
                        <h1 class="text-lg font-bold text-cham-blue">CHAM TOEIC</h1>
                    </div>
                    <div class="hidden sm:block">
                        <div class="text-sm font-medium text-gray-900">TOEIC Listening Mock Test #3</div>
                        <div class="text-xs text-gray-500">Part 1 - Photographs</div>
                    </div>
                </div>

                <!-- Timer and Progress -->
                <div class="flex items-center space-x-6">
                    <!-- Progress Bar -->
                    <div class="hidden md:flex items-center space-x-2">
                        <span class="text-sm text-gray-600">Tiến độ:</span>
                        <div class="w-32 bg-gray-200 rounded-full h-2">
                            <div id="progressBar" class="bg-cham-blue h-2 rounded-full transition-all duration-300" style="width: 15%"></div>
                        </div>
                        <span id="progressText" class="text-sm font-medium text-gray-900">3/20</span>
                    </div>

                    <!-- Timer -->
                    <div id="timerContainer" class="flex items-center space-x-2 px-3 py-1 bg-cham-green text-white rounded-md">
                        <i class="fas fa-clock"></i>
                        <span id="timer" class="font-mono font-medium">42:35</span>
                    </div>

                    <!-- Emergency Help -->
                    <button id="helpBtn" class="p-2 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100">
                        <i class="fas fa-question-circle text-xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="pt-16 h-screen flex">
        <!-- Question Palette Sidebar -->
        <div id="questionPalette" class="hidden lg:block w-64 bg-white border-r border-gray-200 overflow-y-auto">
            <div class="p-4">
                <h3 class="text-sm font-semibold text-gray-900 mb-3">Danh sách câu hỏi</h3>
                <div class="grid grid-cols-5 gap-2 question-palette">
                    <!-- Question numbers will be generated here -->
                </div>
                
                <div class="mt-6">
                    <h4 class="text-xs font-medium text-gray-700 mb-2">Chú thích:</h4>
                    <div class="space-y-1 text-xs">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-cham-blue rounded"></div>
                            <span class="text-gray-600">Đã trả lời</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-cham-yellow rounded"></div>
                            <span class="text-gray-600">Đánh dấu</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 bg-gray-200 rounded"></div>
                            <span class="text-gray-600">Chưa trả lời</span>
                        </div>
                    </div>
                </div>

                <button id="reviewFlagged" class="w-full mt-4 bg-cham-yellow text-white px-3 py-2 rounded-md text-sm font-medium hover:bg-yellow-600 transition-colors">
                    Xem câu đã đánh dấu (2)
                </button>
            </div>
        </div>

        <!-- Main Test Area -->
        <div class="flex-1 flex flex-col lg:flex-row">
            <!-- Question Area (60% on desktop) -->
            <div class="flex-1 lg:w-3/5 bg-white overflow-y-auto">
                <div class="p-6">
                    <!-- Question Header -->
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-4">
                            <div class="bg-cham-blue text-white px-3 py-1 rounded-full text-sm font-medium">
                                Câu 3
                            </div>
                            <div class="text-sm text-gray-600">Part 1 - Photographs</div>
                        </div>
                        
                        <!-- Accessibility Controls -->
                        <div class="flex items-center space-x-2">
                            <button id="fontSizeBtn" class="p-2 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100" title="Tăng cỡ chữ">
                                <i class="fas fa-text-height"></i>
                            </button>
                            <button id="contrastBtn" class="p-2 text-gray-400 hover:text-gray-600 rounded-md hover:bg-gray-100" title="Chế độ tương phản cao">
                                <i class="fas fa-adjust"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Audio Controls (for Listening parts) -->
                    <div class="audio-controls rounded-lg p-4 mb-6 text-white">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-medium">Audio Controls</h4>
                            <div class="text-sm opacity-90">Track 3</div>
                        </div>
                        
                        <div class="flex items-center space-x-4">
                            <button id="playBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-3 rounded-full transition-colors">
                                <i class="fas fa-play text-lg"></i>
                            </button>
                            <button id="pauseBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 p-3 rounded-full transition-colors hidden">
                                <i class="fas fa-pause text-lg"></i>
                            </button>
                            
                            <!-- Progress bar -->
                            <div class="flex-1 mx-4">
                                <div class="bg-white bg-opacity-20 rounded-full h-2">
                                    <div id="audioProgress" class="bg-white h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <!-- Volume Control -->
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-volume-up"></i>
                                <input type="range" id="volumeSlider" min="0" max="100" value="80" class="w-16">
                            </div>
                            
                            <!-- Speed Control -->
                            <select id="speedControl" class="bg-white bg-opacity-20 text-white rounded px-2 py-1 text-sm">
                                <option value="0.75">0.75x</option>
                                <option value="1" selected>1x</option>
                                <option value="1.25">1.25x</option>
                            </select>
                        </div>
                    </div>

                    <!-- Question Content -->
                    <div class="mb-6">
                        <div class="text-lg leading-relaxed text-gray-900 mb-4" id="questionText">
                            Look at the picture and choose the best description.
                        </div>
                        
                        <!-- Image with zoom functionality -->
                        <div class="text-center mb-6">
                            <img id="questionImage" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 300'%3E%3Crect width='400' height='300' fill='%23f3f4f6'/%3E%3Ctext x='200' y='150' text-anchor='middle' fill='%236b7280' font-size='16' font-family='Arial'%3EQuestion Image%3C/text%3E%3C/svg%3E" 
                                 alt="Question image" 
                                 class="zoomable max-w-full h-auto rounded-lg shadow-md mx-auto cursor-pointer"
                                 style="max-height: 300px;">
                        </div>
                    </div>

                    <!-- Reference Materials (if applicable) -->
                    <div class="bg-gray-50 rounded-lg p-4 mb-6 hidden" id="referenceMaterials">
                        <h4 class="font-medium text-gray-900 mb-2">Tài liệu tham khảo</h4>
                        <div class="text-sm text-gray-700">
                            <!-- Reference content would go here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Answer Area (40% on desktop) -->
            <div class="w-full lg:w-2/5 bg-gray-50 border-l border-gray-200 overflow-y-auto">
                <div class="p-6">
                    <!-- Answer Options -->
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Chọn đáp án:</h3>
                        
                        <div class="space-y-3" id="answerOptions">
                            <label class="answer-option flex items-start space-x-3 p-4 border border-gray-200 rounded-lg hover:bg-white hover:border-cham-blue cursor-pointer transition-all">
                                <input type="radio" name="answer" value="A" class="mt-1 text-cham-blue focus:ring-cham-blue">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">A.</div>
                                    <div class="text-gray-700 mt-1">A woman is reading a newspaper.</div>
                                </div>
                            </label>
                            
                            <label class="answer-option flex items-start space-x-3 p-4 border border-gray-200 rounded-lg hover:bg-white hover:border-cham-blue cursor-pointer transition-all">
                                <input type="radio" name="answer" value="B" class="mt-1 text-cham-blue focus:ring-cham-blue">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">B.</div>
                                    <div class="text-gray-700 mt-1">A woman is typing on a computer.</div>
                                </div>
                            </label>
                            
                            <label class="answer-option flex items-start space-x-3 p-4 border border-gray-200 rounded-lg hover:bg-white hover:border-cham-blue cursor-pointer transition-all">
                                <input type="radio" name="answer" value="C" class="mt-1 text-cham-blue focus:ring-cham-blue">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">C.</div>
                                    <div class="text-gray-700 mt-1">A woman is talking on the phone.</div>
                                </div>
                            </label>
                            
                            <label class="answer-option flex items-start space-x-3 p-4 border border-gray-200 rounded-lg hover:bg-white hover:border-cham-blue cursor-pointer transition-all">
                                <input type="radio" name="answer" value="D" class="mt-1 text-cham-blue focus:ring-cham-blue">
                                <div class="flex-1">
                                    <div class="font-medium text-gray-900">D.</div>
                                    <div class="text-gray-700 mt-1">A woman is writing in a notebook.</div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex items-center space-x-3 mb-6">
                        <button id="flagBtn" class="flex items-center space-x-2 px-4 py-2 border border-cham-yellow text-cham-yellow hover:bg-cham-yellow hover:text-white rounded-md transition-colors">
                            <i class="fas fa-flag"></i>
                            <span>Đánh dấu</span>
                        </button>
                        
                        <button id="clearBtn" class="flex items-center space-x-2 px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-md transition-colors">
                            <i class="fas fa-eraser"></i>
                            <span>Xóa</span>
                        </button>
                    </div>

                    <!-- Notes Section -->
                    <div class="mb-6">
                        <button id="notesToggle" class="flex items-center space-x-2 text-cham-blue hover:text-blue-700 mb-3">
                            <i class="fas fa-sticky-note"></i>
                            <span>Ghi chú</span>
                            <i class="fas fa-chevron-down transform transition-transform" id="notesChevron"></i>
                        </button>
                        
                        <div id="notesSection" class="hidden">
                            <textarea id="notesText" class="w-full h-24 p-3 border border-gray-300 rounded-md resize-none focus:ring-2 focus:ring-cham-blue focus:border-transparent" placeholder="Ghi chú của bạn..."></textarea>
                        </div>
                    </div>

                    <!-- Navigation Controls -->
                    <div class="flex items-center justify-between">
                        <button id="prevBtn" class="flex items-center space-x-2 px-4 py-2 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded-md transition-colors">
                            <i class="fas fa-chevron-left"></i>
                            <span>Câu trước</span>
                        </button>
                        
                        <button id="nextBtn" class="flex items-center space-x-2 px-4 py-2 bg-cham-blue text-white hover:bg-blue-700 rounded-md transition-colors">
                            <span>Câu tiếp</span>
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>

                    <!-- Submit Test Button (shown on last question) -->
                    <button id="submitBtn" class="hidden w-full mt-4 bg-cham-green text-white px-4 py-3 rounded-md font-medium hover:bg-green-600 transition-colors">
                        <i class="fas fa-check-circle mr-2"></i>
                        Nộp bài kiểm tra
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 text-center">
            <div class="loading-spinner w-8 h-8 border-4 border-cham-blue border-t-transparent rounded-full mx-auto mb-4"></div>
            <div class="text-gray-900 font-medium">Đang tải câu hỏi...</div>
        </div>
    </div>

    <!-- Connection Issues Modal -->
    <div id="connectionModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md mx-4">
            <div class="text-center">
                <i class="fas fa-wifi text-4xl text-cham-red mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Mất kết nối</h3>
                <p class="text-gray-600 mb-4">Đang cố gắng kết nối lại. Đáp án của bạn đã được lưu tự động.</p>
                <div class="flex items-center justify-center space-x-2">
                    <div class="loading-spinner w-4 h-4 border-2 border-cham-blue border-t-transparent rounded-full"></div>
                    <span class="text-sm text-gray-600">Đang kết nối lại...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Submit Confirmation Modal -->
    <div id="submitModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md mx-4">
            <div class="text-center">
                <i class="fas fa-exclamation-triangle text-4xl text-cham-yellow mb-4"></i>
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Xác nhận nộp bài</h3>
                <p class="text-gray-600 mb-4">Bạn có chắc chắn muốn nộp bài? Bạn sẽ không thể thay đổi đáp án sau khi nộp.</p>
                <div class="bg-gray-50 rounded-lg p-3 mb-4">
                    <div class="text-sm text-gray-600">
                        <div>Đã trả lời: <span class="font-medium">18/20 câu</span></div>
                        <div>Đã đánh dấu: <span class="font-medium">2 câu</span></div>
                        <div>Thời gian còn lại: <span class="font-medium">38:42</span></div>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button id="cancelSubmit" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-md transition-colors">
                        Hủy
                    </button>
                    <button id="confirmSubmit" class="flex-1 px-4 py-2 bg-cham-green text-white hover:bg-green-600 rounded-md transition-colors">
                        Nộp bài
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-lg mx-4 max-h-96 overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Trợ giúp</h3>
                <button id="closeHelp" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <div class="space-y-4 text-sm">
                <div>
                    <h4 class="font-medium text-gray-900 mb-2">Phím tắt:</h4>
                    <ul class="space-y-1 text-gray-600">
                        <li><kbd class="bg-gray-100 px-2 py-1 rounded">1</kbd> - Chọn đáp án A</li>
                        <li><kbd class="bg-gray-100 px-2 py-1 rounded">2</kbd> - Chọn đáp án B</li>
                        <li><kbd class="bg-gray-100 px-2 py-1 rounded">3</kbd> - Chọn đáp án C</li>
                        <li><kbd class="bg-gray-100 px-2 py-1 rounded">4</kbd> - Chọn đáp án D</li>
                        <li><kbd class="bg-gray-100 px-2 py-1 rounded">Space</kbd> - Phát/Tạm dừng audio</li>
                        <li><kbd class="bg-gray-100 px-2 py-1 rounded">→</kbd> - Câu tiếp theo</li>
                        <li><kbd class="bg-gray-100 px-2 py-1 rounded">←</kbd> - Câu trước</li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="font-medium text-gray-900 mb-2">Tính năng:</h4>
                    <ul class="space-y-1 text-gray-600">
                        <li>• Đáp án được lưu tự động</li>
                        <li>• Nhấp vào hình ảnh để phóng to</li>
                        <li>• Đánh dấu câu hỏi để xem lại</li>
                        <li>• Ghi chú cho từng câu hỏi</li>
                        <li>• Điều chỉnh tốc độ và âm lượng audio</li>
                    </ul>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <div class="flex items-start space-x-2">
                        <i class="fas fa-exclamation-triangle text-yellow-600 mt-0.5"></i>
                        <div class="text-yellow-800">
                            <div class="font-medium">Lưu ý quan trọng:</div>
                            <div class="text-sm">Không được thoát khỏi chế độ toàn màn hình hoặc chuyển sang ứng dụng khác trong quá trình làm bài.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentQuestion = 3;
        let totalQuestions = 20;
        let timeRemaining = 2555; // seconds
        let isPlaying = false;
        let fontSize = 16;
        let isHighContrast = false;
        let answers = {};
        let flaggedQuestions = new Set([5, 12]);
        let notes = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            generateQuestionPalette();
            updateProgress();
            startTimer();
            setupKeyboardShortcuts();
            setupEventListeners();
            
            // Prevent cheating
            preventCheating();
        });

        // Generate question palette
        function generateQuestionPalette() {
            const palette = document.querySelector('.question-palette');
            for (let i = 1; i <= totalQuestions; i++) {
                const btn = document.createElement('button');
                btn.className = `w-8 h-8 rounded text-sm font-medium transition-colors ${
                    i === currentQuestion ? 'bg-cham-blue text-white' :
                    answers[i] ? 'bg-cham-blue text-white' :
                    flaggedQuestions.has(i) ? 'bg-cham-yellow text-white' :
                    'bg-gray-200 text-gray-700 hover:bg-gray-300'
                }`;
                btn.textContent = i;
                btn.onclick = () => goToQuestion(i);
                palette.appendChild(btn);
            }
        }

        // Timer functionality
        function startTimer() {
            setInterval(() => {
                if (timeRemaining > 0) {
                    timeRemaining--;
                    updateTimerDisplay();
                } else {
                    autoSubmitTest();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const timerElement = document.getElementById('timer');
            const timerContainer = document.getElementById('timerContainer');
            
            timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Update timer color based on remaining time
            if (timeRemaining <= 300) { // 5 minutes
                timerContainer.className = 'flex items-center space-x-2 px-3 py-1 bg-cham-red text-white rounded-md timer-warning';
            } else if (timeRemaining <= 600) { // 10 minutes
                timerContainer.className = 'flex items-center space-x-2 px-3 py-1 bg-cham-yellow text-white rounded-md';
            } else {
                timerContainer.className = 'flex items-center space-x-2 px-3 py-1 bg-cham-green text-white rounded-md';
            }
        }

        // Progress tracking
        function updateProgress() {
            const answeredCount = Object.keys(answers).length;
            const percentage = (answeredCount / totalQuestions) * 100;
            
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('progressText').textContent = `${answeredCount}/${totalQuestions}`;
        }

        // Navigation
        function goToQuestion(questionNum) {
            if (questionNum >= 1 && questionNum <= totalQuestions) {
                currentQuestion = questionNum;
                updateQuestionDisplay();
                generateQuestionPalette();
            }
        }

        function updateQuestionDisplay() {
            // Update question number display
            document.querySelector('.bg-cham-blue.text-white.px-3.py-1').textContent = `Câu ${currentQuestion}`;
            
            // Show/hide navigation buttons
            document.getElementById('prevBtn').disabled = currentQuestion === 1;
            document.getElementById('nextBtn').style.display = currentQuestion === totalQuestions ? 'none' : 'flex';
            document.getElementById('submitBtn').style.display = currentQuestion === totalQuestions ? 'block' : 'none';
            
            // Load saved answer
            const savedAnswer = answers[currentQuestion];
            if (savedAnswer) {
                document.querySelector(`input[value="${savedAnswer}"]`).checked = true;
            } else {
                document.querySelectorAll('input[name="answer"]').forEach(input => input.checked = false);
            }
            
            // Load saved notes
            document.getElementById('notesText').value = notes[currentQuestion] || '';
            
            // Update flag button
            const flagBtn = document.getElementById('flagBtn');
            if (flaggedQuestions.has(currentQuestion)) {
                flagBtn.classList.add('bg-cham-yellow', 'text-white');
                flagBtn.classList.remove('border-cham-yellow', 'text-cham-yellow');
            } else {
                flagBtn.classList.remove('bg-cham-yellow', 'text-white');
                flagBtn.classList.add('border-cham-yellow', 'text-cham-yellow');
            }
        }

        // Audio controls
        function toggleAudio() {
            const playBtn = document.getElementById('playBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (isPlaying) {
                playBtn.classList.remove('hidden');
                pauseBtn.classList.add('hidden');
                isPlaying = false;
            } else {
                playBtn.classList.add('hidden');
                pauseBtn.classList.remove('hidden');
                isPlaying = true;
                simulateAudioProgress();
            }
        }

        function simulateAudioProgress() {
            if (!isPlaying) return;
            
            let progress = 0;
            const interval = setInterval(() => {
                if (!isPlaying || progress >= 100) {
                    clearInterval(interval);
                    if (progress >= 100) {
                        document.getElementById('playBtn').classList.remove('hidden');
                        document.getElementById('pauseBtn').classList.add('hidden');
                        isPlaying = false;
                        document.getElementById('audioProgress').style.width = '0%';
                    }
                    return;
                }
                progress += 2;
                document.getElementById('audioProgress').style.width = `${progress}%`;
            }, 100);
        }

        // Keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                switch(e.key) {
                    case '1':
                        selectAnswer('A');
                        break;
                    case '2':
                        selectAnswer('B');
                        break;
                    case '3':
                        selectAnswer('C');
                        break;
                    case '4':
                        selectAnswer('D');
                        break;
                    case ' ':
                        e.preventDefault();
                        toggleAudio();
                        break;
                    case 'ArrowLeft':
                        if (currentQuestion > 1) goToQuestion(currentQuestion - 1);
                        break;
                    case 'ArrowRight':
                        if (currentQuestion < totalQuestions) goToQuestion(currentQuestion + 1);
                        break;
                }
            });
        }

        function selectAnswer(value) {
            const input = document.querySelector(`input[value="${value}"]`);
            if (input) {
                input.checked = true;
                saveAnswer(value);
            }
        }

        // Save answer
        function saveAnswer(value) {
            answers[currentQuestion] = value;
            updateProgress();
            generateQuestionPalette();
            
            // Show saving indicator
            showSavingIndicator();
        }

        function showSavingIndicator() {
            // Could add a small saving indicator here
        }

        // Event listeners
        function setupEventListeners() {
            // Answer selection
            document.querySelectorAll('input[name="answer"]').forEach(input => {
                input.addEventListener('change', function() {
                    saveAnswer(this.value);
                });
            });

            // Navigation
            document.getElementById('prevBtn').addEventListener('click', () => {
                if (currentQuestion > 1) goToQuestion(currentQuestion - 1);
            });

            document.getElementById('nextBtn').addEventListener('click', () => {
                if (currentQuestion < totalQuestions) goToQuestion(currentQuestion + 1);
            });

            // Audio controls
            document.getElementById('playBtn').addEventListener('click', toggleAudio);
            document.getElementById('pauseBtn').addEventListener('click', toggleAudio);

            // Volume control
            document.getElementById('volumeSlider').addEventListener('input', function() {
                // Volume control logic would go here
            });

            // Speed control
            document.getElementById('speedControl').addEventListener('change', function() {
                // Speed control logic would go here
            });

            // Flag question
            document.getElementById('flagBtn').addEventListener('click', function() {
                if (flaggedQuestions.has(currentQuestion)) {
                    flaggedQuestions.delete(currentQuestion);
                } else {
                    flaggedQuestions.add(currentQuestion);
                }
                updateQuestionDisplay();
                generateQuestionPalette();
                updateFlaggedCount();
            });

            // Clear answer
            document.getElementById('clearBtn').addEventListener('click', function() {
                document.querySelectorAll('input[name="answer"]').forEach(input => input.checked = false);
                delete answers[currentQuestion];
                updateProgress();
                generateQuestionPalette();
            });

            // Notes toggle
            document.getElementById('notesToggle').addEventListener('click', function() {
                const notesSection = document.getElementById('notesSection');
                const chevron = document.getElementById('notesChevron');
                
                if (notesSection.classList.contains('hidden')) {
                    notesSection.classList.remove('hidden');
                    chevron.classList.add('rotate-180');
                } else {
                    notesSection.classList.add('hidden');
                    chevron.classList.remove('rotate-180');
                }
            });

            // Save notes
            document.getElementById('notesText').addEventListener('input', function() {
                notes[currentQuestion] = this.value;
            });

            // Accessibility controls
            document.getElementById('fontSizeBtn').addEventListener('click', function() {
                fontSize = fontSize >= 20 ? 14 : fontSize + 2;
                document.body.style.fontSize = `${fontSize}px`;
            });

            document.getElementById('contrastBtn').addEventListener('click', function() {
                isHighContrast = !isHighContrast;
                if (isHighContrast) {
                    document.body.classList.add('high-contrast');
                } else {
                    document.body.classList.remove('high-contrast');
                }
            });

            // Image zoom
            document.getElementById('questionImage').addEventListener('click', function() {
                this.classList.toggle('zoomed');
            });

            // Submit test
            document.getElementById('submitBtn').addEventListener('click', function() {
                document.getElementById('submitModal').classList.remove('hidden');
            });

            // Submit confirmation
            document.getElementById('confirmSubmit').addEventListener('click', function() {
                submitTest();
            });

            document.getElementById('cancelSubmit').addEventListener('click', function() {
                document.getElementById('submitModal').classList.add('hidden');
            });

            // Help modal
            document.getElementById('helpBtn').addEventListener('click', function() {
                document.getElementById('helpModal').classList.remove('hidden');
            });

            document.getElementById('closeHelp').addEventListener('click', function() {
                document.getElementById('helpModal').classList.add('hidden');
            });

            // Review flagged questions
            document.getElementById('reviewFlagged').addEventListener('click', function() {
                const flaggedArray = Array.from(flaggedQuestions);
                if (flaggedArray.length > 0) {
                    goToQuestion(flaggedArray[0]);
                }
            });
        }

        function updateFlaggedCount() {
            document.getElementById('reviewFlagged').textContent = `Xem câu đã đánh dấu (${flaggedQuestions.size})`;
        }

        // Prevent cheating
        function preventCheating() {
            // Disable right-click
            document.addEventListener('contextmenu', e => e.preventDefault());
            
            // Disable common keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && (e.key === 'c' || e.key === 'v' || e.key === 'a' || e.key === 's')) {
                    e.preventDefault();
                }
                if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                    e.preventDefault();
                }
            });

            // Detect tab switching
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // Log tab switch event
                    console.warn('Tab switch detected');
                }
            });

            // Request fullscreen
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            }
        }

        // Auto-submit when time runs out
        function autoSubmitTest() {
            alert('Hết thời gian! Bài kiểm tra sẽ được nộp tự động.');
            submitTest();
        }

        // Submit test
        function submitTest() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            
            // Simulate submission
            setTimeout(() => {
                alert('Nộp bài thành công! Chuyển đến trang kết quả...');
                document.getElementById('loadingOverlay').classList.add('hidden');
            }, 2000);
        }

        // Simulate connection issues
        setTimeout(() => {
            document.getElementById('connectionModal').classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('connectionModal').classList.add('hidden');
            }, 3000);
        }, 10000);

        // Initialize flagged count
        updateFlaggedCount();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'96dce35d418f5dd2',t:'MTc1NDk2OTM2NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
